{"version":3,"sources":["../src/useSSE.ts"],"sourcesContent":["import { useEffect, useRef, useState, useCallback } from \"react\";\r\n\r\nexport type SSEEvent<T = any> = {\r\n  id?: string;\r\n  event?: string;\r\n  data: T; // data는 항상 파싱된 상태로 전달됨\r\n};\r\n\r\nexport type UseSSEOptions = {\r\n  withCredentials?: boolean;\r\n  retryDelay?: number;\r\n  maxRetryDelay?: number;\r\n  onOpen?: (ev: Event) => void;\r\n  onError?: (err: Event | Error) => void;\r\n};\r\n\r\n// JSON 자동 파서\r\n\r\nfunction parseData(raw: string): any {\r\n  try {\r\n    return JSON.parse(raw);\r\n  } catch {\r\n    return raw; // JSON이 아니면 문자열 그대로\r\n  }\r\n}\r\n\r\nexport function useSSE<T = any>(url: string | null, options?: UseSSEOptions) {\r\n  const {\r\n    withCredentials = false,\r\n    retryDelay = 1000,\r\n    maxRetryDelay = 30000,\r\n    onOpen,\r\n    onError,\r\n  } = options || {};\r\n\r\n  const eventRef = useRef<EventSource | null>(null); // EventSource 인스턴스\r\n  const retryRef = useRef<number>(retryDelay); // 재시도 대기시간\r\n  const reconnectTimer = useRef<number | null>(null); // 재연결 setTimeout id\r\n  const listenersRef = useRef(new Set<(e: SSEEvent<T>) => void>()); // subscribe 콜백\r\n\r\n  const [connected, setConnected] = useState(false); // 연결 상태 UI\r\n  const [lastMessage, setLastMessage] = useState<SSEEvent<T> | null>(null); // 마지막 수신 이벤트\r\n  const [messages, setMessages] = useState<SSEEvent<T>[]>([]); // 누적 메세지\r\n\r\n  const attach = useCallback(\r\n    (src: EventSource) => {\r\n      src.onopen = (ev) => {\r\n        retryRef.current = retryDelay; // 재시도 대기 시간 리셋\r\n        setConnected(true); // 연결상태 True\r\n        onOpen?.(ev); // onOpen 옵션\r\n      };\r\n\r\n      src.onerror = (ev) => {\r\n        setConnected(false); // 연결이 끊기면 연결상태 false 처리\r\n        onError?.(ev); // onError 옵션\r\n\r\n        if (!reconnectTimer.current) {\r\n          reconnectTimer.current = window.setTimeout(() => {\r\n            reconnectTimer.current = null;\r\n\r\n            const es = eventRef.current;\r\n            if (!es || es.readyState === EventSource.CLOSED) {\r\n              connect();\r\n            }\r\n          }, retryRef.current);\r\n\r\n          retryRef.current = Math.min(retryRef.current * 2, maxRetryDelay);\r\n        }\r\n      };\r\n\r\n      src.onmessage = (ev) => {\r\n        const parsed: SSEEvent<T> = {\r\n          id: (ev as any).lastEventId,\r\n          event: ev.type,\r\n          data: parseData(ev.data),\r\n        };\r\n\r\n        // 내부 상태 업데이트\r\n        setLastMessage(parsed);\r\n        setMessages((prev) => [...prev, parsed]);\r\n\r\n        // listener 호출\r\n        listenersRef.current.forEach((fn) => fn(parsed));\r\n      };\r\n    },\r\n    [onOpen, onError, retryDelay, maxRetryDelay]\r\n  );\r\n\r\n  const connect = useCallback(() => {\r\n    if (!url) return;\r\n\r\n    if (eventRef.current) {\r\n      try {\r\n        eventRef.current.close();\r\n      } catch {}\r\n    }\r\n\r\n    const es = new EventSource(url, { withCredentials });\r\n    eventRef.current = es;\r\n\r\n    attach(es);\r\n  }, [url, withCredentials, attach]);\r\n\r\n  // URL 변경 시 연결\r\n\r\n  useEffect(() => {\r\n    if (!url) return;\r\n\r\n    connect();\r\n\r\n    return () => {\r\n      if (reconnectTimer.current) clearTimeout(reconnectTimer.current);\r\n      if (eventRef.current) {\r\n        try {\r\n          eventRef.current.close();\r\n        } catch {}\r\n        eventRef.current = null;\r\n      }\r\n    };\r\n  }, [url, connect]);\r\n\r\n  const subscribe = useCallback((cb: (e: SSEEvent<T>) => void) => {\r\n    listenersRef.current.add(cb);\r\n    return () => listenersRef.current.delete(cb);\r\n  }, []);\r\n\r\n  const close = useCallback(() => {\r\n    if (eventRef.current) {\r\n      try {\r\n        eventRef.current.close();\r\n      } catch {}\r\n      eventRef.current = null;\r\n      setConnected(false);\r\n    }\r\n\r\n    if (reconnectTimer.current) {\r\n      clearTimeout(reconnectTimer.current);\r\n      reconnectTimer.current = null;\r\n    }\r\n  }, []);\r\n\r\n  return {\r\n    connected,\r\n    lastMessage, // 마지막 메시지\r\n    messages, // 모든 메시지 배열 (자동 누적)\r\n    subscribe,\r\n    close,\r\n    reconnect: connect,\r\n  };\r\n}\r\n"],"mappings":"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","names":[]}